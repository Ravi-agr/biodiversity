from django.db.models.query_utils import Qfrom django.shortcuts import renderfrom django.http import HttpResponse, Http404from biodiv.models import *from django.db.models import Countimport jsonerror_response = {"error": "Invalid API URL"}def apiSpecies(request, id, type):    #Retrieving Species with Species ID = id from table Species    try:        species = Species.objects.get(species_id=id)    except Species.DoesNotExist:        return HttpResponse(json.dumps(error_response), content_type="application/json")        #Record retrieved    response_data = {}    if type == "name":        response_data['species_id'] = species.species_id        if species.scientific_name:            response_data['name'] = species.scientific_name        else:            response_data['name'] = species.name        #Retrieving Synonyms, Accepted names from table Names        catalouge_name = Names.objects.filter(species_id=id)        if catalouge_name:            response_data['accepted_name'] = catalouge_name[0].accepted_name + " " + catalouge_name[                                                                                     0].accepted_authority        else:            response_data['accepted_name'] = "N/A"        response_data['synonyms'] = []        for item in catalouge_name:            response_data['synonyms'].append(item.synonym + " " + item.authority)            #Record(s) retrieved        #Retrieving Common Names from table Common Names        common_list = CommonNames.objects.filter(species_id=id)        response_data['common_names'] = []        for item in common_list:            response_data['common_names'].append(item.common_name)            #Record(s) retrieved    elif type == "classification":        clazz = Classification.objects.get(species_id=id)        response_data = {"species_id": id,                         "kingdom": clazz.kingdom,                         "phylum": clazz.phylum,                         "clazz": clazz.class_field,                         "order": clazz.order,                         "family": clazz.family,                         "genus": clazz.genus,                         "scientific_name": species.scientific_name        }    elif type == "status":        try:            iucn = IucnData.objects.get(species_id=id)            response_data["iucn_status"] = iucn.status        except IucnData.DoesNotExist:            response_data["iucn_status"] = "Not Listed"        try:            others = Status.objects.get(species_id=id)            response_data["cites_appendix"] = others.cites            response_data["nrdb_status"] = others.nrdb            response_data["protected"] = others.protected if "Yes" else "No"            response_data["endemic"] = others.endemic if "Yes" else "No"        except Status.DoesNotExist:            response_data["cites_appendix"] = "Not Listed"            response_data["nrdb_status"] = "Not Listed"            response_data["protected"] = "No"            response_data["endemic"] = "No"    elif type == "protected_areas":        protected = SpeciesPa.objects.filter(species_id=id)        response_data["species_id"] = id        response_data["protected_areas"] = [];        for item in protected:            p = item.pa_id            pa = {"pa_id": p.pa_id, "name": p.name, "designation": p.designation}            response_data["protected_areas"].append(pa)    else:        return HttpResponse(json.dumps(error_response), content_type="application/json")    return HttpResponse(json.dumps(response_data), content_type="application/json")def apiProtected(request, id, type):    try:        pa = ProtectedAreas.objects.get(pa_id=id)    except ProtectedAreas.DoesNotExist:        return HttpResponse(json.dumps(error_response), content_type="application/json")    response_data = {}    if type == "basics":        response_data = {"pa_id": pa.pa_id,                         "name": pa.name + " " + pa.designation,                         "type": pa.designation,                         "estd_year": pa.estd_year,                         "iucn_category": pa.iucn_category,                         "area": pa.area        }    elif type == "species_count":        response_data = ProtectedAreas.objects.speciesCount(id)    elif type == "species_checklist":        response_data = ProtectedAreas.objects.speciesChecklist(id)    else:        return HttpResponse(json.dumps(error_response), content_type="application/json")    return HttpResponse(json.dumps(response_data), content_type="application/json")def apiOthers(request, type, group="all"):    response_data = {}    if type == "count":        response_data = Species.objects.speciesCount(group)    elif type == "checklist":        response_data = Species.objects.speciesChecklist(group)    else:        return HttpResponse(json.dumps(error_response), content_type="application/json")    return HttpResponse(json.dumps(response_data), content_type="application/json")def csvProtectedChecklist(request, id):    try:        pa = ProtectedAreas.objects.get(pa_id=id)    except ProtectedAreas.DoesNotExist:        return HttpResponse(json.dumps(error_response), content_type="application/json")    import csv    response_data = ProtectedAreas.objects.speciesChecklist(id)    response = HttpResponse(mimetype='text/csv')    response['Content-Disposition'] = 'attachment;filename=export.csv'    field_names = ["Species ID", "Group", "Name"]    writer = csv.writer(response)    writer.writerow(field_names)    for group, species in response_data.iteritems():        for item in species:            writer.writerow([item['species_id'], group, item['name']])    return responsedef csvSpeciesChecklist(request, group='all'):    import csv    response_data = Species.objects.speciesChecklist(group)    response = HttpResponse(mimetype='text/csv')    response['Content-Disposition'] = 'attachment;filename=export.csv'    if group == 'all':        field_names = ["Species ID", "Group", "Name"]    else:        field_names = ["Species ID", "Family", "Name"]    writer = csv.writer(response)    writer.writerow(field_names)    for group, species in response_data.iteritems():        for item in species:            writer.writerow([item['species_id'], group, item['name']])    return responsedef threats(request, type, pa):    def getFullCategory(code):        if code == "LC": return "Least Concern"        if code == "NT": return "Near Threatened"        if code == "VU": return "Vulnerable"        if code == "EN": return "Endangered"        if code == "CR": return "Critically Endangered"        if code == "DD": return "Data Deficient"    if type == "iucn_category":        if int(pa) > 0:            species = SpeciesPa.objects.filter(pa_id=pa).values_list('species_id')            data = IucnData.objects.filter(species_id__in=species).values('status').annotate(Count('status'))        else:            data = IucnData.objects.all().values('status').annotate(Count('status'))        response_data = {'name': 'IUCN Category', 'children': []}        response_data['children'].append({'name': "Threatened", 'children': []})        for item in data:            if item['status'] in ['CR', 'EN', 'VU']:                response_data['children'][0]['children'].append(                        {'name': getFullCategory(item['status']), 'size': item['status__count']})            else:                response_data['children'].append(                        {'name': getFullCategory(item['status']), 'size': item['status__count']})    return HttpResponse(json.dumps(response_data), content_type="application/json")def classification_flare_json(reques, pa_id):    pa_id = int(pa_id)    if pa_id > 0:        species_ids = SpeciesPa.objects.filter(pa_id=pa_id).values_list('species_id', flat=True)        clazz = Classification.objects.filter(species_id__in=species_ids).order_by('kingdom', 'phylum', 'class_field',            'order', 'family', 'genus', 'species_id').select_related()    else:        clazz = Classification.objects.all().order_by('kingdom', 'phylum', 'class_field', 'order', 'family', 'genus',            'species_id').select_related()    tree = {'name': "root", 'children': []}    def get_previous(type):        types = ['kingdom', 'phylum', 'class_field', 'order', 'family', 'genus', 'species_id']        n = types.index(type)        sub_tree = tree['children']        if not sub_tree: return None        for i in range(0, n):            if not sub_tree: return None            sub_tree = sub_tree[len(sub_tree) - 1]['children']        if not sub_tree: return None        last_item = sub_tree[len(sub_tree) - 1]        return last_item['name']    def append(type, item):        types = ['kingdom', 'phylum', 'class_field', 'order', 'family', 'genus', 'species_id']        n = types.index(type)        sub_tree = tree['children']        for i in range(0, n + 1):            if not sub_tree: return None            sub_tree = sub_tree[len(sub_tree) - 1]['children']        sub_tree.append(item)    for item in clazz:        while True:            if item.kingdom == get_previous('kingdom'):                if item.phylum == get_previous('phylum'):                    if item.class_field == get_previous('class_field'):                        if item.order == get_previous('order'):                            if item.family == get_previous('family'):                                if item.genus == get_previous('genus'):                                    append('genus', {'name': item.species_id.name, 'size': 1})                                    break;                                else:                                    append('family', {'name': item.genus, 'children': []})                            else:                                append('order', {'name': item.family, 'children': []})                        else:                            append('class_field', {'name': item.order, 'children': []})                    else:                        append('phylum', {'name': item.class_field, 'children': []})                else:                    append('kingdom', {'name': item.phylum, 'children': []})            else:                tree['children'].append({'name': item.kingdom, 'children': []})    return HttpResponse(json.dumps(tree), content_type="application/json")def classification_flare_json(request, pa_id):    clazz = Classification.objects.all().order_by('kingdom', 'phylum', 'class_field', 'order', 'family', 'genus',        'species_id').select_related()[:20000]    tree = {'name': "root", 'children': []}    def get_previous(type):        types = ['kingdom', 'phylum', 'class_field', 'order', 'family', 'genus', 'species_id']        n = types.index(type)        sub_tree = tree['children']        if not sub_tree: return None        for i in range(0, n):            if not sub_tree: return None            sub_tree = sub_tree[len(sub_tree) - 1]['children']        if not sub_tree: return None        last_item = sub_tree[len(sub_tree) - 1]        return last_item['name']    def append(type, item):        types = ['kingdom', 'phylum', 'class_field', 'order', 'family', 'genus', 'species_id']        n = types.index(type)        sub_tree = tree['children']        for i in range(0, n + 1):            if not sub_tree: return None            sub_tree = sub_tree[len(sub_tree) - 1]['children']        sub_tree.append(item)    for item in clazz:        while True:            if item.kingdom == get_previous('kingdom'):                if item.phylum == get_previous('phylum'):                    if item.class_field == get_previous('class_field'):                        if item.order == get_previous('order'):                            if item.family == get_previous('family'):                                if item.genus == get_previous('genus'):                                    append('genus', {'name': item.species_id.name, 'type': 'species', 'size': 1})                                    break;                                else:                                    append('family', {'name': item.genus, 'type': 'genus', 'children': []})                            else:                                append('order', {'name': item.family, 'type': 'family', 'children': []})                        else:                            append('class_field', {'name': item.order, 'type': 'order', 'children': []})                    else:                        append('phylum', {'name': item.class_field, 'type': 'class_field', 'children': []})                else:                    append('kingdom', {'name': item.phylum, 'type': 'phylum', 'children': []})            else:                tree['children'].append({'name': item.kingdom, 'type': 'kingdom', 'children': []})    return HttpResponse(json.dumps(tree), content_type="application/json")def count_family(request, pa_id):    pa_id = int(pa_id)    if pa_id > 0:        species_ids = SpeciesPa.objects.filter(pa_id=pa_id).values_list('species_id', flat=True)        clazz = Classification.objects.filter(species_id__in=species_ids).select_related().order_by('kingdom',            'species_id__group', 'order', 'family').values('kingdom', 'species_id__group', 'phylum', 'class_field',            'order', 'family').annotate(Count('family'))    else:        clazz = Classification.objects.all().select_related().order_by('kingdom', 'species_id__group', 'order',            'family').values('kingdom', 'species_id__group', 'phylum', 'class_field', 'order', 'family').annotate(            Count('family'))    tree = {'name': "root", 'children': []}    def get_previous(type):        types = ['kingdom', 'species_id__group', 'order', 'family']        n = types.index(type)        sub_tree = tree['children']        if not sub_tree: return None        for i in range(0, n):            if not sub_tree: return None            sub_tree = sub_tree[len(sub_tree) - 1]['children']        if not sub_tree: return None        last_item = sub_tree[len(sub_tree) - 1]        return last_item['name']    def append(type, item):        types = ['kingdom', 'species_id__group', 'order', 'family']        n = types.index(type)        sub_tree = tree['children']        for i in range(0, n + 1):            if not sub_tree: return None            sub_tree = sub_tree[len(sub_tree) - 1]['children']        sub_tree.append(item)    for item in clazz:        while True:            if item['kingdom'] == get_previous('kingdom'):                if item['species_id__group'] == get_previous('species_id__group'):                    if item['order'] == get_previous('order'):                        append('order', {'name': item['family'], 'size': item['family__count']})                        break;                    else:                        append('species_id__group', {'name': item['order'], 'children': []})                else:                    append('kingdom', {'name': item['species_id__group'], 'children': []})            else:                tree['children'].append({'name': item['kingdom'], 'children': []})    return HttpResponse(json.dumps(tree), content_type="application/json")def area_hierarchy(request):    pa = ProtectedAreas.objects.filter(area__gt=0).exclude(Q(description__contains='Redirect')).order_by('pa_id')    tree = {'name': "Protected Areas", 'children': []}    for item in pa:        found = False        for type in tree['children']:            if type['name'] == item.designation:                type['children'].append({'name': item.name, 'size': item.area})                found = True                break        if not found:            tree['children'].append({'name': item.designation, 'children': [{'name': item.name, 'size': item.area}]})    return HttpResponse(json.dumps(tree), content_type="application/json")def iucn_classification(request, type):    iucn_json = json.load(open("iucn.json"))    field_name = ""    if type == "threat":        iucn_no_dot = iucn_json['threat']        field_name = 'threat_number'        iucn_clazz = IucnThreat.objects.values('threat_number').annotate(Count('threat_number')).order_by(            'threat_number')    elif type == "habitat":        iucn_no_dot = iucn_json['habitat']        field_name = 'habitat_number'        iucn_clazz = IucnHabitat.objects.values('habitat_number').annotate(Count('habitat_number')).order_by(            'habitat_number')    elif type == "conservation":        iucn_no_dot = iucn_json['conservation']        field_name = 'conservation_number'        iucn_clazz = IucnConservation.objects.values('conservation_number').annotate(Count('conservation_number')).order_by(            'conservation_number')    iucn = {}    for key, item in iucn_no_dot.items():        iucn[key + '.'] = item    tree = {'name': type, 'children': []}    def get_last(level):        sub_tree = tree['children']        for i in range(level):            if not sub_tree: return None            sub_tree = sub_tree[len(sub_tree) - 1]['children']        if not sub_tree: return None        return sub_tree[len(sub_tree) - 1]    for item in iucn_clazz:        lvl = item[field_name].split('.')        if len(lvl) == 3:            last = get_last(0)            if not last or last['id'] != lvl[0] + ".":                tree['children'].append({'name': iucn[lvl[0] + "."], 'id': lvl[0] + ".", 'children': []})                last = get_last(0)            last['children'].append({'name': iucn[item[field_name]], 'id': item[field_name],                                     'size': item[field_name + "__count"]})        elif len(lvl) == 4:            last = get_last(0)            if not last or last['id'] != lvl[0] + ".":                tree['children'].append({'name': iucn[lvl[0] + "."], 'id': lvl[0] + ".", 'children': []})                last = get_last(0)                last['children'].append(                        {'name': iucn[lvl[0] + "." + lvl[1] + "."], 'id': lvl[0] + "." + lvl[1] + ".", 'children': []})                last = get_last(1)                last['children'].append({'name': iucn[item[field_name]], 'id': item[field_name],                                         'size': item[field_name + "__count"]})            else:                last = get_last(1)                if not last or last['id'] != lvl[0] + "." + lvl[1] + ".":                    last = get_last(0)                    last['children'].append(                            {'name': iucn[lvl[0] + "." + lvl[1] + "."], 'id': lvl[0] + "." + lvl[1] + ".",                             'children': []})                    last = get_last(1)                    last['children'].append({'name': iucn[item[field_name]], 'id': item[field_name],                                             'size': item[field_name + "__count"]})                else:                    last['children'].append({'name': iucn[item[field_name]], 'id': item[field_name],                                             'size': item[field_name + "__count"]})    return HttpResponse(json.dumps(tree), content_type="application/json")